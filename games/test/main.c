#include "GameEngine.h"
#include "bg.img.h"
#include "person.img.h"
#include "person_run.img.h"

unsigned char map_image[] = {
    0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x33, 0x33, 0x13, 0x33, 0x33, 0x31, 0x33, 0x33, 0x33, 0x33, 0x33,
    0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x31, 0x33, 0x33,
    0x33, 0xf3, 0xf3, 0x33, 0x33, 0x13, 0x33, 0x33, 0x33, 0xff, 0xf3, 0x33, 0x33, 0x33, 0x33, 0x33, 0x1f, 0xf9, 0x9f,
    0x33, 0x13, 0x33, 0x3f, 0xf1, 0xff, 0x9f, 0xff, 0x31, 0xf3, 0x33, 0xff, 0xff, 0xff, 0xf9, 0xf9, 0x3f, 0xf3, 0x33,
    0xff, 0xff, 0xff, 0xff, 0xff, 0x9f, 0xff, 0x31, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x31, 0xff, 0xf9, 0xff,
    0xff, 0xff, 0xff, 0xff, 0x1f, 0xff, 0x9f, 0x9f, 0xff, 0xff, 0xf9, 0xff, 0xff, 0xff, 0xf9, 0xff, 0x9f, 0xff, 0x9f,
    0x9f, 0xff, 0xff, 0xff, 0xf9, 0xf9, 0xff, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xff, 0x9f, 0xff, 0xff, 0x9f, 0xff, 0xff,
    0xff, 0xff, 0x9f, 0xff, 0xf9, 0xf9, 0xff, 0xff, 0xff, 0xf9, 0xf9, 0xff, 0xff, 0x9f, 0xff, 0xff, 0xff, 0xff, 0x9f,
    0xff, 0xff, 0xff, 0xff, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x9f, 0x9f, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf9, 0x9f, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0x9f, 0xff, 0x9f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf9, 0xf9, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0x9f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0x9f, 0x9f, 0xff, 0xff, 0xf9, 0xff, 0xff, 0xff, 0xf9, 0xff, 0x9f, 0xff, 0x9f, 0x9f, 0xff, 0xff, 0xff, 0xf9,
    0xf9, 0xff, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xff, 0x9f, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0xcc, 0x1c,
    0x11, 0x11, 0x11, 0x11, 0x11, 0xc1, 0xcc, 0xc1, 0x9c, 0xc1, 0x1c, 0xc1, 0xc9, 0xcc, 0xcc, 0xcc, 0x9c, 0xcc, 0xcc,
    0xcc, 0x19, 0xcc, 0xcc, 0xcc, 0x9c, 0xcc, 0xcc, 0xcc, 0xc9, 0xcc, 0xcc, 0xcc, 0x9c, 0xcc, 0xcc, 0xcc, 0xc9, 0xcc,
    0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xcc, 0xcc, 0x1c, 0x1c, 0x9c, 0xcc, 0x1c, 0x19, 0xcc, 0xcc, 0xc1,
    0xc1, 0x9c, 0xcc, 0xc1, 0xc9, 0xcc, 0xcc, 0xcc, 0x1c, 0x9c, 0xcc, 0xcc, 0x19, 0xcc, 0xcc, 0xcc, 0xcc, 0x9c, 0xcc,
    0xcc, 0xc9, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0x99, 0xc1, 0xc9, 0xcc, 0xcc, 0xc1, 0xc1, 0x9c, 0xcc, 0xcc,
    0x19, 0xcc, 0xcc, 0xcc, 0x1c, 0x9c, 0xcc, 0xcc, 0xc9, 0xcc, 0xcc, 0xcc, 0xc1, 0x9c, 0xcc, 0xcc, 0xc9, 0xcc, 0xcc,
    0xcc, 0xcc, 0x9c, 0xcc};

// 20 x 8
unsigned char level0[] = {
    2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0,
    0, 0, 0, 0, 3, 3, 3, 3, 0, 0, 0, 3, 3, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 3, 0, 0, 2, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 1, 2, 1, 1, 1, 1, 1,
    2, 2, 1, 1, 1, 1, 2, 2, 2, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
};

void game_main() {
    Image person_idle = loadImage(person_data, IMG_Palette, 40, 32, 6);
    Image person_run  = loadImage(person_run_data, IMG_Palette, 40, 32, 8);
    Image map         = loadImage(map_image, IMG_Palette, 16, 16, 3);
    Image background  = loadImage(bg_data, IMG_Palette, bg_width, bg_height, 1);

    Sprite sprite = {
        .image         = &person_idle,
        .left          = 10,
        .right         = 25,
        .top           = 4,
        .bottom        = 32,
        .collision     = 3,
        .x             = 50,
        .y             = 10,
        .accelerationy = 1,
        .framerate     = 4,
    };

    TileMap tilemap = {.image = &map, .mapw = 20, .maph = 8, .map = level0, .collision = level0};

    Background bg = {
        .x     = 0,
        .y     = 0,
        .image = &background,
    };

    loadBackground(&bg);
    loadTileMap(&tilemap);
    loadSprite(&sprite);

    setFramerate(25);
    while (1) {
        unsigned char key = getKey();

        if (key & KEY_RIGHT) {
            sprite.speedx = 2;
            sprite.image  = &person_run;
        } else if ((key & KEY_LEFT)) {
            sprite.speedx = -2;
            sprite.image  = &person_run;
        } else {
            sprite.speedx = 0;
            sprite.image  = &person_idle;
        }

        if (key & KEY_UP)
            sprite.speedy = -5;

        gameTick();

        screenRoll(-sprite.speedx, 0);
    }
}
